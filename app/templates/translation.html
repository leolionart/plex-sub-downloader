{% extends "base.html" %}

{% block title %}Translation Approval - Plex Subtitle Service{% endblock %}
{% block nav_translation %}active{% endblock %}
{% block page_title %}Translation Approval{% endblock %}
{% block page_description %}Review và approve yêu cầu dịch subtitle{% endblock %}

{% block extra_styles %}
<style>
    .pending-item {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 12px;
        transition: border-color var(--transition-fast);
    }

    .pending-item:hover {
        border-color: var(--border-default);
    }

    .pending-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        gap: 12px;
    }

    .pending-item h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .pending-item .meta {
        font-size: 13px;
        color: var(--text-muted);
    }

    .estimate-box {
        background: var(--bg-input);
        border-radius: var(--radius-md);
        padding: 14px 16px;
        margin: 12px 0;
        border: 1px solid var(--border-subtle);
    }

    .estimate-loading {
        color: var(--text-muted);
        font-size: 13px;
    }

    .estimate-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .estimate-row span:last-child {
        color: var(--text-primary);
        font-weight: 500;
    }

    .estimate-row.total {
        border-top: 1px solid var(--border-subtle);
        margin-top: 8px;
        padding-top: 10px;
        font-weight: 600;
        font-size: 15px;
    }

    .estimate-row.total span:last-child {
        color: var(--plex-gold);
    }

    .pending-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
    }

    .pending-actions .btn {
        flex: 1;
        font-size: 13px;
        padding: 9px 16px;
    }

    /* ── History Section ── */
    .section-divider {
        margin: 40px 0 24px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .section-divider h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
    }

    .section-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border-subtle);
    }

    .history-table {
        width: 100%;
        border-collapse: collapse;
    }

    .history-table th {
        text-align: left;
        padding: 10px 12px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .history-table td {
        padding: 12px;
        font-size: 14px;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-subtle);
        vertical-align: middle;
    }

    .history-table tr:last-child td {
        border-bottom: none;
    }

    .history-table tr:hover td {
        background: var(--bg-surface);
    }

    .history-title {
        color: var(--text-primary);
        font-weight: 500;
    }

    .history-meta {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-approved {
        background: var(--success-dim);
        color: var(--success);
    }

    .status-auto_approved {
        background: var(--info-dim);
        color: var(--info);
    }

    .status-rejected {
        background: var(--error-dim);
        color: var(--error);
    }

    .history-empty {
        text-align: center;
        padding: 32px;
        color: var(--text-muted);
        font-size: 14px;
    }

    .history-stats {
        display: flex;
        gap: 24px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .history-stat {
        display: flex;
        align-items: baseline;
        gap: 6px;
        font-size: 13px;
        color: var(--text-muted);
    }

    .history-stat strong {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* ── Preview Modal ── */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal {
        background: var(--bg-base);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        width: min(90vw, 720px);
        max-height: 85vh;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
        flex-shrink: 0;
    }

    .modal-header h3 {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        margin-right: 12px;
    }

    .modal-header .modal-meta {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        font-size: 20px;
        line-height: 1;
        flex-shrink: 0;
    }

    .modal-close:hover {
        color: var(--text-primary);
    }

    .modal-body {
        overflow-y: auto;
        flex: 1;
        padding: 0;
    }

    .sub-entry {
        display: flex;
        gap: 12px;
        padding: 10px 20px;
        border-bottom: 1px solid var(--border-subtle);
        font-size: 13px;
    }

    .sub-entry:hover {
        background: var(--bg-surface);
    }

    .sub-entry:last-child {
        border-bottom: none;
    }

    .sub-time {
        color: var(--plex-gold);
        font-family: monospace;
        font-size: 11px;
        white-space: nowrap;
        flex-shrink: 0;
        padding-top: 1px;
    }

    .sub-text {
        color: var(--text-primary);
        line-height: 1.5;
        word-break: break-word;
    }

    .modal-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 48px 20px;
        color: var(--text-muted);
        font-size: 14px;
    }

    .modal-error {
        text-align: center;
        padding: 48px 20px;
        color: var(--error);
        font-size: 14px;
    }

    .modal-footer {
        padding: 12px 20px;
        border-top: 1px solid var(--border-subtle);
        font-size: 12px;
        color: var(--text-muted);
        text-align: center;
        flex-shrink: 0;
    }

    .btn-view {
        background: none;
        border: 1px solid var(--border-subtle);
        color: var(--text-secondary);
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        font-size: 12px;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-view:hover {
        border-color: var(--plex-gold);
        color: var(--plex-gold);
    }

    @media (max-width: 768px) {
        .pending-item-header {
            flex-direction: column;
        }
        .pending-actions {
            flex-direction: column;
        }
        .history-table th:nth-child(3),
        .history-table td:nth-child(3),
        .history-table th:nth-child(5),
        .history-table td:nth-child(5) {
            display: none;
        }
        .modal {
            width: 95vw;
            max-height: 90vh;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="pending-list">
    <div class="empty-state">
        <div class="empty-icon"><span class="spinner" style="width:32px;height:32px;border-width:3px;"></span></div>
        <h2>Loading...</h2>
    </div>
</div>

<!-- Translation History -->
<div class="section-divider">
    <h2>Translation History</h2>
</div>

<div id="history-stats" class="history-stats" style="display:none;"></div>

<div id="history-section">
    <div class="history-empty">Loading history...</div>
</div>

<!-- Subtitle Preview Modal -->
<div id="preview-modal" class="modal-overlay" onclick="if(event.target===this)closePreview()">
    <div class="modal">
        <div class="modal-header">
            <div>
                <h3 id="preview-title">Loading...</h3>
                <div class="modal-meta" id="preview-meta"></div>
            </div>
            <button class="modal-close" onclick="closePreview()">&times;</button>
        </div>
        <div class="modal-body" id="preview-body">
            <div class="modal-loading"><span class="spinner"></span> Loading subtitle...</div>
        </div>
        <div class="modal-footer" id="preview-footer"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let pendingItems = [];

    async function loadPending() {
        try {
            const response = await fetch('/api/translation/pending');
            const data = await response.json();

            pendingItems = data.items;
            renderPending();
        } catch (error) {
            showAlert('Error loading pending translations: ' + error.message, 'error');
        }
    }

    function renderPending() {
        const container = document.getElementById('pending-list');

        if (pendingItems.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2>No Pending Translations</h2>
                    <p>All translation requests have been processed</p>
                </div>
            `;
            return;
        }

        container.innerHTML = pendingItems.map(item => `
            <div class="pending-item" id="item-${item.rating_key}">
                <div class="pending-item-header">
                    <div>
                        <h3>${item.title}</h3>
                        <p class="meta">
                            ${item.from_lang.toUpperCase()} &rarr; ${item.to_lang.toUpperCase()} &nbsp;&middot;&nbsp;
                            Added: ${new Date(item.added_at).toLocaleString()}
                        </p>
                    </div>
                    <span class="tag tag-warning" id="badge-${item.rating_key}">Pending</span>
                </div>

                <div id="estimate-${item.rating_key}" class="estimate-box">
                    <p class="estimate-loading">Click "Estimate Cost" to see translation cost</p>
                </div>

                <div class="pending-actions">
                    <button class="btn btn-info" onclick="estimateCost('${item.rating_key}', '${item.from_lang}', '${item.to_lang}')">
                        Estimate Cost
                    </button>
                    <button class="btn btn-success" onclick="approve('${item.rating_key}', '${item.from_lang}', '${item.to_lang}')" disabled id="approve-${item.rating_key}">
                        Approve &amp; Translate
                    </button>
                    <button class="btn btn-danger" onclick="reject('${item.rating_key}')">
                        Reject
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function estimateCost(ratingKey, fromLang, toLang) {
        const estimateBox = document.getElementById(`estimate-${ratingKey}`);
        estimateBox.innerHTML = '<p class="estimate-loading"><span class="spinner"></span> &nbsp;Calculating cost...</p>';

        try {
            const response = await fetch('/api/translation/estimate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    rating_key: ratingKey,
                    from_lang: fromLang,
                    to_lang: toLang
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Estimation failed');
            }

            const estimate = await response.json();

            estimateBox.innerHTML = `
                <div class="estimate-row">
                    <span>Subtitle Lines:</span>
                    <span>${estimate.subtitle_entries.toLocaleString()}</span>
                </div>
                <div class="estimate-row">
                    <span>Characters:</span>
                    <span>${estimate.total_characters.toLocaleString()}</span>
                </div>
                <div class="estimate-row">
                    <span>Est. Tokens:</span>
                    <span>${estimate.estimated_tokens.toLocaleString()}</span>
                </div>
                <div class="estimate-row">
                    <span>Model:</span>
                    <span>${estimate.model}</span>
                </div>
                <div class="estimate-row total">
                    <span>Estimated Cost:</span>
                    <span>$${estimate.estimated_cost_usd.toFixed(4)} USD</span>
                </div>
            `;

            document.getElementById(`approve-${ratingKey}`).disabled = false;

        } catch (error) {
            estimateBox.innerHTML = `<p style="color: var(--error);">Error: ${error.message}</p>`;
        }
    }

    async function approve(ratingKey, fromLang, toLang) {
        if (!confirm('Approve this translation? This will consume OpenAI API credits.')) {
            return;
        }

        const badge = document.getElementById(`badge-${ratingKey}`);
        badge.className = 'tag tag-info';
        badge.textContent = 'Processing...';

        const itemEl = document.getElementById(`item-${ratingKey}`);
        const buttons = itemEl.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);

        try {
            const response = await fetch('/api/translation/approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    rating_key: ratingKey,
                    from_lang: fromLang,
                    to_lang: toLang
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Translation failed');
            }

            const result = await response.json();
            showAlert(result.message, 'success');

            setTimeout(() => { loadPending(); loadHistory(); }, 2000);

        } catch (error) {
            showAlert('Translation failed: ' + error.message, 'error');
            buttons.forEach(btn => btn.disabled = false);
            badge.className = 'tag tag-warning';
            badge.textContent = 'Pending';
        }
    }

    async function reject(ratingKey) {
        if (!confirm('Reject this translation request?')) {
            return;
        }

        try {
            const response = await fetch('/api/translation/reject', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rating_key: ratingKey})
            });

            if (!response.ok) {
                throw new Error('Rejection failed');
            }

            showAlert('Translation request rejected', 'success');
            loadPending();
            loadHistory();

        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    // ── History ──────────────────────────────────────────────────────

    const statusLabels = {
        approved: 'Approved',
        auto_approved: 'Auto',
        rejected: 'Rejected',
    };

    const statusIcons = {
        approved: '&#10003;',
        auto_approved: '&#9889;',
        rejected: '&#10007;',
    };

    async function loadHistory() {
        try {
            const response = await fetch('/api/translation/history?limit=50');
            const data = await response.json();
            renderHistory(data.items);
        } catch (error) {
            document.getElementById('history-section').innerHTML =
                '<div class="history-empty">Failed to load history</div>';
        }
    }

    function renderHistory(items) {
        const section = document.getElementById('history-section');
        const statsEl = document.getElementById('history-stats');

        if (!items || items.length === 0) {
            section.innerHTML = '<div class="history-empty">No translation history yet</div>';
            statsEl.style.display = 'none';
            return;
        }

        // Stats summary
        const approved = items.filter(i => i.status === 'approved').length;
        const auto = items.filter(i => i.status === 'auto_approved').length;
        const rejected = items.filter(i => i.status === 'rejected').length;
        const totalLines = items.reduce((s, i) => s + (i.lines_translated || 0), 0);

        statsEl.style.display = 'flex';
        statsEl.innerHTML = `
            <div class="history-stat"><strong>${approved + auto}</strong> translated</div>
            <div class="history-stat"><strong>${auto}</strong> auto</div>
            <div class="history-stat"><strong>${rejected}</strong> rejected</div>
            <div class="history-stat"><strong>${totalLines.toLocaleString()}</strong> lines</div>
        `;

        section.innerHTML = `
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Lines</th>
                        <th>Date</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map(item => {
                        const canPreview = item.status !== 'rejected' && item.lines_translated > 0;
                        return `
                        <tr>
                            <td>
                                <div class="history-title">${item.title}</div>
                                <div class="history-meta">${item.from_lang.toUpperCase()} &rarr; ${item.to_lang.toUpperCase()}${item.model ? ' &middot; ' + item.model : ''}</div>
                            </td>
                            <td>
                                <span class="status-badge status-${item.status}">
                                    ${statusIcons[item.status] || ''} ${statusLabels[item.status] || item.status}
                                </span>
                            </td>
                            <td>${item.lines_translated ? item.lines_translated.toLocaleString() : '—'}</td>
                            <td>${formatDate(item.timestamp)}</td>
                            <td>${canPreview ? `<button class="btn-view" onclick="openPreview('${item.rating_key}','${item.to_lang}','${item.title.replace(/'/g, "\\'")}')">View</button>` : ''}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    function formatDate(iso) {
        if (!iso) return '—';
        const d = new Date(iso);
        const now = new Date();
        const diff = now - d;

        // Trong vòng 24h → hiện "x giờ trước"
        if (diff < 86400000) {
            const hours = Math.floor(diff / 3600000);
            if (hours < 1) {
                const mins = Math.floor(diff / 60000);
                return mins <= 0 ? 'Just now' : `${mins}m ago`;
            }
            return `${hours}h ago`;
        }

        // Trong vòng 7 ngày → hiện "x ngày trước"
        if (diff < 604800000) {
            const days = Math.floor(diff / 86400000);
            return `${days}d ago`;
        }

        return d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // ── Subtitle Preview ──────────────────────────────────────────

    function openPreview(ratingKey, lang, title) {
        const modal = document.getElementById('preview-modal');
        const body = document.getElementById('preview-body');
        const titleEl = document.getElementById('preview-title');
        const metaEl = document.getElementById('preview-meta');
        const footerEl = document.getElementById('preview-footer');

        titleEl.textContent = title;
        metaEl.textContent = `Language: ${lang.toUpperCase()}`;
        body.innerHTML = '<div class="modal-loading"><span class="spinner"></span> Loading subtitle from Plex...</div>';
        footerEl.textContent = '';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        fetch(`/api/translation/preview/${ratingKey}?lang=${lang}`)
            .then(r => {
                if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
                return r.json();
            })
            .then(data => {
                if (!data.entries || data.entries.length === 0) {
                    body.innerHTML = '<div class="modal-error">No subtitle entries found</div>';
                    return;
                }

                body.innerHTML = data.entries.map(e =>
                    `<div class="sub-entry">` +
                        `<span class="sub-time">${e.start.substring(0, 8)}</span>` +
                        `<span class="sub-text">${escapeHtml(e.text)}</span>` +
                    `</div>`
                ).join('');

                const suffix = data.truncated ? ` (showing first 500 of ${data.total_lines})` : '';
                footerEl.textContent = `${data.total_lines} entries${suffix}`;
            })
            .catch(err => {
                body.innerHTML = `<div class="modal-error">${escapeHtml(err.message)}</div>`;
            });
    }

    function closePreview() {
        document.getElementById('preview-modal').classList.remove('active');
        document.body.style.overflow = '';
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closePreview();
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    setInterval(loadPending, 30000);
    loadPending();
    loadHistory();
</script>
{% endblock %}
