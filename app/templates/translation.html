{% extends "base.html" %}

{% block title %}Translation Approval - Plex Subtitle Service{% endblock %}
{% block nav_translation %}active{% endblock %}
{% block page_title %}Translation Approval{% endblock %}
{% block page_description %}Review và approve yêu cầu dịch subtitle{% endblock %}

{% block extra_styles %}
<style>
    .pending-item {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 12px;
        transition: border-color var(--transition-fast);
    }

    .pending-item:hover {
        border-color: var(--border-default);
    }

    .pending-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        gap: 12px;
    }

    .pending-item h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .pending-item .meta {
        font-size: 13px;
        color: var(--text-muted);
    }

    .estimate-box {
        background: var(--bg-input);
        border-radius: var(--radius-md);
        padding: 14px 16px;
        margin: 12px 0;
        border: 1px solid var(--border-subtle);
    }

    .estimate-loading {
        color: var(--text-muted);
        font-size: 13px;
    }

    .estimate-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .estimate-row span:last-child {
        color: var(--text-primary);
        font-weight: 500;
    }

    .estimate-row.total {
        border-top: 1px solid var(--border-subtle);
        margin-top: 8px;
        padding-top: 10px;
        font-weight: 600;
        font-size: 15px;
    }

    .estimate-row.total span:last-child {
        color: var(--plex-gold);
    }

    .pending-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
    }

    .pending-actions .btn {
        flex: 1;
        font-size: 13px;
        padding: 9px 16px;
    }

    @media (max-width: 768px) {
        .pending-item-header {
            flex-direction: column;
        }
        .pending-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="pending-list">
    <div class="empty-state">
        <div class="empty-icon"><span class="spinner" style="width:32px;height:32px;border-width:3px;"></span></div>
        <h2>Loading...</h2>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let pendingItems = [];

    async function loadPending() {
        try {
            const response = await fetch('/api/translation/pending');
            const data = await response.json();

            pendingItems = data.items;
            renderPending();
        } catch (error) {
            showAlert('Error loading pending translations: ' + error.message, 'error');
        }
    }

    function renderPending() {
        const container = document.getElementById('pending-list');

        if (pendingItems.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2>No Pending Translations</h2>
                    <p>All translation requests have been processed</p>
                </div>
            `;
            return;
        }

        container.innerHTML = pendingItems.map(item => `
            <div class="pending-item" id="item-${item.rating_key}">
                <div class="pending-item-header">
                    <div>
                        <h3>${item.title}</h3>
                        <p class="meta">
                            ${item.from_lang.toUpperCase()} &rarr; ${item.to_lang.toUpperCase()} &nbsp;&middot;&nbsp;
                            Added: ${new Date(item.added_at).toLocaleString()}
                        </p>
                    </div>
                    <span class="tag tag-warning" id="badge-${item.rating_key}">Pending</span>
                </div>

                <div id="estimate-${item.rating_key}" class="estimate-box">
                    <p class="estimate-loading">Click "Estimate Cost" to see translation cost</p>
                </div>

                <div class="pending-actions">
                    <button class="btn btn-info" onclick="estimateCost('${item.rating_key}', '${item.from_lang}', '${item.to_lang}')">
                        Estimate Cost
                    </button>
                    <button class="btn btn-success" onclick="approve('${item.rating_key}', '${item.from_lang}', '${item.to_lang}')" disabled id="approve-${item.rating_key}">
                        Approve &amp; Translate
                    </button>
                    <button class="btn btn-danger" onclick="reject('${item.rating_key}')">
                        Reject
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function estimateCost(ratingKey, fromLang, toLang) {
        const estimateBox = document.getElementById(`estimate-${ratingKey}`);
        estimateBox.innerHTML = '<p class="estimate-loading"><span class="spinner"></span> &nbsp;Calculating cost...</p>';

        try {
            const response = await fetch('/api/translation/estimate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    rating_key: ratingKey,
                    from_lang: fromLang,
                    to_lang: toLang
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Estimation failed');
            }

            const estimate = await response.json();

            estimateBox.innerHTML = `
                <div class="estimate-row">
                    <span>Subtitle Lines:</span>
                    <span>${estimate.subtitle_entries.toLocaleString()}</span>
                </div>
                <div class="estimate-row">
                    <span>Characters:</span>
                    <span>${estimate.total_characters.toLocaleString()}</span>
                </div>
                <div class="estimate-row">
                    <span>Est. Tokens:</span>
                    <span>${estimate.estimated_tokens.toLocaleString()}</span>
                </div>
                <div class="estimate-row">
                    <span>Model:</span>
                    <span>${estimate.model}</span>
                </div>
                <div class="estimate-row total">
                    <span>Estimated Cost:</span>
                    <span>$${estimate.estimated_cost_usd.toFixed(4)} USD</span>
                </div>
            `;

            document.getElementById(`approve-${ratingKey}`).disabled = false;

        } catch (error) {
            estimateBox.innerHTML = `<p style="color: var(--error);">Error: ${error.message}</p>`;
        }
    }

    async function approve(ratingKey, fromLang, toLang) {
        if (!confirm('Approve this translation? This will consume OpenAI API credits.')) {
            return;
        }

        const badge = document.getElementById(`badge-${ratingKey}`);
        badge.className = 'tag tag-info';
        badge.textContent = 'Processing...';

        const itemEl = document.getElementById(`item-${ratingKey}`);
        const buttons = itemEl.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);

        try {
            const response = await fetch('/api/translation/approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    rating_key: ratingKey,
                    from_lang: fromLang,
                    to_lang: toLang
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Translation failed');
            }

            const result = await response.json();
            showAlert(result.message, 'success');

            setTimeout(() => loadPending(), 2000);

        } catch (error) {
            showAlert('Translation failed: ' + error.message, 'error');
            buttons.forEach(btn => btn.disabled = false);
            badge.className = 'tag tag-warning';
            badge.textContent = 'Pending';
        }
    }

    async function reject(ratingKey) {
        if (!confirm('Reject this translation request?')) {
            return;
        }

        try {
            const response = await fetch('/api/translation/reject', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rating_key: ratingKey})
            });

            if (!response.ok) {
                throw new Error('Rejection failed');
            }

            showAlert('Translation request rejected', 'success');
            loadPending();

        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    setInterval(loadPending, 30000);
    loadPending();
</script>
{% endblock %}
