{% extends "base.html" %}

{% block title %}Settings - Plex Subtitle Service{% endblock %}
{% block nav_settings %}active{% endblock %}
{% block page_title %}Settings{% endblock %}
{% block page_description %}Cấu hình subtitle download và xử lý tự động{% endblock %}

{% block extra_styles %}
<style>
    /* ── Multi-select Searchable Component ── */
    /* Override card overflow so dropdown can overlay */
    .card:has(.multi-select) {
        overflow: visible;
    }

    .multi-select {
        position: relative;
    }

    .multi-select-trigger {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
        min-height: 42px;
        width: 100%;
        padding: 6px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: border-color var(--transition-fast);
    }

    .multi-select-trigger:hover {
        border-color: var(--text-muted);
    }

    .multi-select.open .multi-select-trigger {
        border-color: var(--plex-gold);
        box-shadow: 0 0 0 3px var(--plex-gold-dim);
    }

    .multi-select-trigger .placeholder {
        color: var(--text-muted);
        font-size: 14px;
        padding: 2px 4px;
    }

    .multi-select-trigger .chevron {
        margin-left: auto;
        padding-left: 8px;
        color: var(--text-muted);
        transition: transform 0.2s;
        flex-shrink: 0;
        font-size: 12px;
    }

    .multi-select.open .chevron {
        transform: rotate(180deg);
    }

    /* Selected tags */
    .lang-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        background: var(--plex-gold-dim);
        color: var(--plex-gold);
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
        line-height: 1.4;
    }

    .lang-tag.primary {
        background: var(--plex-gold);
        color: #1A1A1A;
    }

    .lang-tag .tag-label {
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .lang-tag .tag-remove {
        cursor: pointer;
        opacity: 0.7;
        font-size: 14px;
        line-height: 1;
    }

    .lang-tag .tag-remove:hover {
        opacity: 1;
    }

    .lang-tag.primary .tag-remove:hover {
        opacity: 0.8;
    }

    /* Dropdown */
    .multi-select-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        z-index: 100;
        max-height: 300px;
        overflow: hidden;
        flex-direction: column;
    }

    .multi-select.open .multi-select-dropdown {
        display: flex;
    }

    .multi-select-search {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .multi-select-search input {
        width: 100%;
        padding: 8px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        font-size: 13px;
        font-family: inherit;
        outline: none;
    }

    .multi-select-search input:focus {
        border-color: var(--plex-gold);
    }

    .multi-select-search input::placeholder {
        color: var(--text-muted);
    }

    .multi-select-options {
        overflow-y: auto;
        flex: 1;
    }

    .multi-select-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        cursor: pointer;
        transition: background var(--transition-fast);
        font-size: 14px;
    }

    .multi-select-option:hover {
        background: var(--bg-surface-hover);
    }

    .multi-select-option.selected {
        background: var(--plex-gold-dim);
    }

    .multi-select-option .check-box {
        width: 18px;
        height: 18px;
        border: 2px solid var(--border-subtle);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all var(--transition-fast);
    }

    .multi-select-option.selected .check-box {
        background: var(--plex-gold);
        border-color: var(--plex-gold);
    }

    .multi-select-option.selected .check-box::after {
        content: '';
        width: 5px;
        height: 9px;
        border: solid #1A1A1A;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg) translateY(-1px);
    }

    .multi-select-option .lang-name {
        flex: 1;
        color: var(--text-primary);
    }

    .multi-select-option.selected .lang-name {
        color: var(--plex-gold);
    }

    .multi-select-option .lang-code {
        color: var(--text-muted);
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .multi-select-option.selected .lang-code {
        color: var(--plex-gold);
        opacity: 0.7;
    }

    .multi-select-empty {
        padding: 16px;
        text-align: center;
        color: var(--text-muted);
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_downloads }}</div>
        <div class="stat-label">Downloaded</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_translations }}</div>
        <div class="stat-label">AI Translated</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_syncs }}</div>
        <div class="stat-label">Timing Synced</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.success_rate }}%</div>
        <div class="stat-label">Success Rate</div>
    </div>
</div>

<form id="settings-form">
    <!-- Language Settings -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Target Languages</h2>
        </div>
        <div class="card-body">
            <div class="form-group" style="margin-bottom: 0;">
                <label>Ngôn ngữ subtitle mục tiêu</label>
                <div class="form-hint" style="margin-bottom: 8px;">Ngôn ngữ đầu tiên là primary, dùng cho download, dịch AI, và sync timing</div>
                <div class="multi-select" id="language-select">
                    <div class="multi-select-trigger" id="language-trigger">
                        <span class="placeholder">Chọn ngôn ngữ...</span>
                        <span class="chevron">&#9662;</span>
                    </div>
                    <div class="multi-select-dropdown">
                        <div class="multi-select-search">
                            <input type="text" id="language-search" placeholder="Tìm ngôn ngữ..." autocomplete="off">
                        </div>
                        <div class="multi-select-options" id="language-options"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Conditions -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Download Conditions</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="auto_download_on_add">
                <div class="toggle-switch">
                    <input type="checkbox" id="auto_download_on_add" name="auto_download_on_add" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto-download when media added</div>
                    <div class="toggle-desc">Tự động tải subtitle khi thêm phim/tập mới vào thư viện</div>
                </div>
            </label>

            <label class="toggle-group" for="auto_download_on_play">
                <div class="toggle-switch">
                    <input type="checkbox" id="auto_download_on_play" name="auto_download_on_play">
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto-download on playback</div>
                    <div class="toggle-desc">Tải subtitle khi user bắt đầu xem (nếu chưa có)</div>
                </div>
            </label>

            <label class="toggle-group" style="cursor:default;">
                <div class="toggle-label">
                    <div class="toggle-title">New Media Delay</div>
                    <div class="toggle-desc">Chỉ áp dụng cho event media added — chờ Plex index metadata</div>
                </div>
                <select id="new_media_delay_seconds" name="new_media_delay_seconds" class="form-select" style="width:auto; min-width:120px; flex-shrink:0;">
                    <option value="0">Tắt</option>
                    <option value="10">10 giây</option>
                    <option value="30" selected>30 giây</option>
                    <option value="60">60 giây</option>
                    <option value="120">2 phút</option>
                    <option value="300">5 phút</option>
                </select>
            </label>
        </div>
    </div>

    <!-- Duplicate Prevention -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Duplicate Prevention</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="skip_if_has_subtitle">
                <div class="toggle-switch">
                    <input type="checkbox" id="skip_if_has_subtitle" name="skip_if_has_subtitle" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Skip if subtitle exists</div>
                    <div class="toggle-desc">Bỏ qua nếu đã có subtitle cùng ngôn ngữ</div>
                </div>
            </label>

            <label class="toggle-group" for="replace_existing">
                <div class="toggle-switch">
                    <input type="checkbox" id="replace_existing" name="replace_existing">
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Replace existing subtitles</div>
                    <div class="toggle-desc">Thay thế subtitle cũ bằng subtitle mới (nếu quality tốt hơn)</div>
                </div>
            </label>

            <label class="toggle-group" for="skip_forced_subtitles">
                <div class="toggle-switch">
                    <input type="checkbox" id="skip_forced_subtitles" name="skip_forced_subtitles" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Skip forced subtitles</div>
                    <div class="toggle-desc">Không download nếu đã có forced subtitle</div>
                </div>
            </label>

            <label class="toggle-group" for="skip_if_embedded">
                <div class="toggle-switch">
                    <input type="checkbox" id="skip_if_embedded" name="skip_if_embedded" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Skip embedded subtitles</div>
                    <div class="toggle-desc">Không download nếu video có embedded subtitle (PGS, VobSub)</div>
                </div>
            </label>
        </div>
    </div>

    <!-- AI Sync Timing -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Sync Timing</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="auto_sync_timing">
                <div class="toggle-switch">
                    <input type="checkbox" id="auto_sync_timing" name="auto_sync_timing" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto Sync Timing</div>
                    <div class="toggle-desc">Tự động sync timing sau khi download subtitle từ Subsource</div>
                </div>
            </label>
        </div>
    </div>

    <!-- AI Translation -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Translation</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="translation_enabled">
                <div class="toggle-switch">
                    <input type="checkbox" id="translation_enabled" name="translation_enabled">
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto Translate (Eng → Target)</div>
                    <div class="toggle-desc">Tự động dịch Engsub sang ngôn ngữ target khi không tìm thấy subtitle</div>
                </div>
            </label>

            <label class="toggle-group" for="translation_requires_approval">
                <div class="toggle-switch">
                    <input type="checkbox" id="translation_requires_approval" name="translation_requires_approval" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Require Approval</div>
                    <div class="toggle-desc">Yêu cầu duyệt trước khi dịch tự động (qua Web UI hoặc Telegram)</div>
                </div>
            </label>

            <div class="form-group" style="margin-top: 16px; margin-bottom: 0;">
                <label for="translation_batch_concurrency">Parallel Batches</label>
                <div class="toggle-desc" style="margin-bottom: 8px;">Số batch dịch gửi đồng thời (tăng = nhanh hơn, giảm nếu bị rate limit)</div>
                <input type="number" id="translation_batch_concurrency" name="translation_batch_concurrency"
                       class="form-input" min="1" max="20" value="5" style="width: 80px;">
            </div>
        </div>
    </div>

    <!-- Quality Settings -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h2>Quality Settings</h2>
        </div>
        <div class="card-body">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="min_quality_threshold">Minimum Quality Threshold</label>
                <select id="min_quality_threshold" name="min_quality_threshold" class="form-select">
                    <option value="any">Any quality</option>
                    <option value="translated" selected>Translated or better</option>
                    <option value="retail">Retail only</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="btn-group">
        <button type="submit" class="btn btn-primary">Save Settings</button>
        <button type="button" class="btn btn-ghost" onclick="loadSettings()">Reset</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    // ── Language data ─────────────────────────────────────
    const LANGUAGES = {{ languages_map | tojson }};
    let selectedLanguages = {{ selected_languages | tojson }};

    // ── Multi-Select Component ────────────────────────────
    const selectEl = document.getElementById('language-select');
    const triggerEl = document.getElementById('language-trigger');
    const searchEl = document.getElementById('language-search');
    const optionsEl = document.getElementById('language-options');

    function cap(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function isSelected(code) {
        return selectedLanguages.includes(code);
    }

    function toggleLanguage(code) {
        if (isSelected(code)) {
            selectedLanguages = selectedLanguages.filter(c => c !== code);
        } else {
            selectedLanguages.push(code);
        }
        updateTrigger();
        renderOptions(searchEl.value);
    }

    function removeLanguage(code, event) {
        if (event) { event.stopPropagation(); event.preventDefault(); }
        selectedLanguages = selectedLanguages.filter(c => c !== code);
        updateTrigger();
        renderOptions(searchEl.value);
    }

    function updateTrigger() {
        // Clear existing tags
        triggerEl.querySelectorAll('.lang-tag').forEach(t => t.remove());
        const placeholder = triggerEl.querySelector('.placeholder');
        const chevron = triggerEl.querySelector('.chevron');

        if (selectedLanguages.length === 0) {
            placeholder.style.display = '';
        } else {
            placeholder.style.display = 'none';
            // Insert tags before chevron
            selectedLanguages.forEach((code, i) => {
                const tag = document.createElement('span');
                tag.className = 'lang-tag' + (i === 0 ? ' primary' : '');
                const name = LANGUAGES[code] ? cap(LANGUAGES[code]) : code.toUpperCase();
                tag.innerHTML = `<span class="tag-label">${name}</span><span class="tag-remove" title="Remove">&#10005;</span>`;
                tag.querySelector('.tag-remove').addEventListener('click', (e) => removeLanguage(code, e));
                triggerEl.insertBefore(tag, chevron);
            });
        }
    }

    function renderOptions(filter = '') {
        optionsEl.innerHTML = '';
        const query = (filter || '').toLowerCase();
        let hasMatch = false;

        for (const [code, name] of Object.entries(LANGUAGES)) {
            if (query && !name.toLowerCase().includes(query) && !code.toLowerCase().includes(query)) {
                continue;
            }
            hasMatch = true;
            const div = document.createElement('div');
            const selected = isSelected(code);
            div.className = 'multi-select-option' + (selected ? ' selected' : '');
            div.innerHTML = `<span class="check-box"></span><span class="lang-name">${cap(name)}</span><span class="lang-code">${code}</span>`;
            div.addEventListener('click', () => toggleLanguage(code));
            optionsEl.appendChild(div);
        }

        if (!hasMatch) {
            optionsEl.innerHTML = '<div class="multi-select-empty">Không tìm thấy ngôn ngữ</div>';
        }
    }

    function openDropdown() {
        selectEl.classList.add('open');
        searchEl.value = '';
        renderOptions();
        setTimeout(() => searchEl.focus(), 50);
    }

    function closeDropdown() {
        selectEl.classList.remove('open');
    }

    triggerEl.addEventListener('click', (e) => {
        // Don't toggle if clicking a tag remove button
        if (e.target.closest('.tag-remove')) return;
        e.preventDefault();
        if (selectEl.classList.contains('open')) {
            closeDropdown();
        } else {
            openDropdown();
        }
    });

    searchEl.addEventListener('input', (e) => renderOptions(e.target.value));
    searchEl.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDropdown(); });

    document.addEventListener('click', (e) => {
        if (!selectEl.contains(e.target)) closeDropdown();
    });

    // Init tags
    updateTrigger();

    // ── Load/Save Settings ────────────────────────────────
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings');
            const data = await response.json();
            const settings = data.subtitle_settings;

            // Languages: restore from saved list
            if (settings.languages && settings.languages.length > 0) {
                selectedLanguages = settings.languages;
            } else if (data.default_language) {
                selectedLanguages = [data.default_language];
            }
            updateTrigger();

            document.getElementById('auto_download_on_add').checked = settings.auto_download_on_add;
            document.getElementById('auto_download_on_play').checked = settings.auto_download_on_play;
            document.getElementById('skip_if_has_subtitle').checked = settings.skip_if_has_subtitle;
            document.getElementById('replace_existing').checked = settings.replace_existing;
            document.getElementById('skip_forced_subtitles').checked = settings.skip_forced_subtitles;
            document.getElementById('skip_if_embedded').checked = settings.skip_if_embedded;
            document.getElementById('min_quality_threshold').value = settings.min_quality_threshold;
            document.getElementById('auto_sync_timing').checked = settings.auto_sync_timing ?? true;
            document.getElementById('translation_enabled').checked = (settings.translation_enabled || settings.auto_translate_if_no_vi) ?? false;
            document.getElementById('translation_requires_approval').checked = settings.translation_requires_approval ?? true;
            document.getElementById('translation_batch_concurrency').value = settings.translation_batch_concurrency ?? 5;
            document.getElementById('new_media_delay_seconds').value = settings.new_media_delay_seconds ?? 30;
        } catch (error) {
            showAlert('Error loading settings: ' + error.message, 'error');
        }
    }

    document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (selectedLanguages.length === 0) {
            showAlert('Vui lòng chọn ít nhất một ngôn ngữ', 'error');
            return;
        }

        const formData = new FormData(e.target);
        const payload = {
            default_language: selectedLanguages[0],
            languages: selectedLanguages,
            language_priority: selectedLanguages,
            auto_download_on_add: formData.get('auto_download_on_add') === 'on',
            auto_download_on_play: formData.get('auto_download_on_play') === 'on',
            skip_if_has_subtitle: formData.get('skip_if_has_subtitle') === 'on',
            replace_existing: formData.get('replace_existing') === 'on',
            skip_forced_subtitles: formData.get('skip_forced_subtitles') === 'on',
            skip_if_embedded: formData.get('skip_if_embedded') === 'on',
            min_quality_threshold: formData.get('min_quality_threshold'),
            auto_sync_timing: formData.get('auto_sync_timing') === 'on',
            translation_enabled: formData.get('translation_enabled') === 'on',
            auto_translate_if_no_vi: formData.get('translation_enabled') === 'on',
            translation_requires_approval: formData.get('translation_requires_approval') === 'on',
            translation_batch_concurrency: Number(formData.get('translation_batch_concurrency')) || 5,
            new_media_delay_seconds: Number(formData.get('new_media_delay_seconds')) || 0,
        };

        try {
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                showAlert('Settings saved successfully!', 'success');
            } else {
                showAlert('Failed to save settings', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    });

    loadSettings();
</script>
{% endblock %}
