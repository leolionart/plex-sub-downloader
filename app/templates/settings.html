{% extends "base.html" %}

{% block title %}Settings - Plex Subtitle Service{% endblock %}
{% block nav_settings %}active{% endblock %}
{% block page_title %}Settings{% endblock %}
{% block page_description %}Cấu hình subtitle download và xử lý tự động{% endblock %}

{% block content %}
<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_downloads }}</div>
        <div class="stat-label">Subtitles Downloaded</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_skipped }}</div>
        <div class="stat-label">Tasks Skipped</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.success_rate }}%</div>
        <div class="stat-label">Success Rate</div>
    </div>
</div>

<form id="settings-form">
    <!-- Language Settings -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Language Settings</h2>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="language-input">Subtitle Languages</label>
                <input type="text" id="language-input" class="form-input"
                       placeholder="Nhập language code (vd: vi, en, ko) rồi nhấn Enter">
                <div class="form-hint">Nhấn Enter để thêm ngôn ngữ. Click x để xóa.</div>
                <div id="language-tags" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>
                <input type="hidden" name="languages" id="languages-hidden">
            </div>
        </div>
    </div>

    <!-- Download Conditions -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Download Conditions</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="auto_download_on_add">
                <div class="toggle-switch">
                    <input type="checkbox" id="auto_download_on_add" name="auto_download_on_add" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto-download when media added</div>
                    <div class="toggle-desc">Tự động tải subtitle khi thêm phim/tập mới vào thư viện</div>
                </div>
            </label>

            <label class="toggle-group" for="auto_download_on_play">
                <div class="toggle-switch">
                    <input type="checkbox" id="auto_download_on_play" name="auto_download_on_play">
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto-download on playback</div>
                    <div class="toggle-desc">Tải subtitle khi user bắt đầu xem (nếu chưa có)</div>
                </div>
            </label>
        </div>
    </div>

    <!-- Duplicate Prevention -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Duplicate Prevention</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="skip_if_has_subtitle">
                <div class="toggle-switch">
                    <input type="checkbox" id="skip_if_has_subtitle" name="skip_if_has_subtitle" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Skip if subtitle exists</div>
                    <div class="toggle-desc">Bỏ qua nếu đã có subtitle cùng ngôn ngữ</div>
                </div>
            </label>

            <label class="toggle-group" for="replace_existing">
                <div class="toggle-switch">
                    <input type="checkbox" id="replace_existing" name="replace_existing">
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Replace existing subtitles</div>
                    <div class="toggle-desc">Thay thế subtitle cũ bằng subtitle mới (nếu quality tốt hơn)</div>
                </div>
            </label>

            <label class="toggle-group" for="skip_forced_subtitles">
                <div class="toggle-switch">
                    <input type="checkbox" id="skip_forced_subtitles" name="skip_forced_subtitles" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Skip forced subtitles</div>
                    <div class="toggle-desc">Không download nếu đã có forced subtitle</div>
                </div>
            </label>

            <label class="toggle-group" for="skip_if_embedded">
                <div class="toggle-switch">
                    <input type="checkbox" id="skip_if_embedded" name="skip_if_embedded" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Skip embedded subtitles</div>
                    <div class="toggle-desc">Không download nếu video có embedded subtitle (PGS, VobSub)</div>
                </div>
            </label>
        </div>
    </div>

    <!-- AI Sync Timing -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Sync Timing</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="auto_sync_timing">
                <div class="toggle-switch">
                    <input type="checkbox" id="auto_sync_timing" name="auto_sync_timing" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Sync Timing</div>
                    <div class="toggle-desc">Đồng bộ timing Vietsub theo Engsub chuẩn kèm phim bằng AI</div>
                </div>
            </label>

            <label class="toggle-group" for="auto_sync_after_download">
                <div class="toggle-switch">
                    <input type="checkbox" id="auto_sync_after_download" name="auto_sync_after_download" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto Sync After Download</div>
                    <div class="toggle-desc">Tự động sync timing ngay sau khi download Vietsub từ Subsource</div>
                </div>
            </label>
        </div>
    </div>

    <!-- AI Translation -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h2>Translation</h2>
        </div>
        <div class="card-body">
            <label class="toggle-group" for="translation_enabled">
                <div class="toggle-switch">
                    <input type="checkbox" id="translation_enabled" name="translation_enabled">
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Auto Translate (Eng → Viet)</div>
                    <div class="toggle-desc">Tự động dịch Engsub sang Vietsub khi không tìm thấy Vietsub</div>
                </div>
            </label>

            <label class="toggle-group" for="translation_requires_approval">
                <div class="toggle-switch">
                    <input type="checkbox" id="translation_requires_approval" name="translation_requires_approval" checked>
                    <span class="toggle-slider"></span>
                </div>
                <div class="toggle-label">
                    <div class="toggle-title">Require Approval</div>
                    <div class="toggle-desc">Yêu cầu duyệt trước khi dịch tự động (qua Web UI hoặc Telegram)</div>
                </div>
            </label>
        </div>
    </div>

    <!-- Quality Settings -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h2>Quality Settings</h2>
        </div>
        <div class="card-body">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="min_quality_threshold">Minimum Quality Threshold</label>
                <select id="min_quality_threshold" name="min_quality_threshold" class="form-select">
                    <option value="any">Any quality</option>
                    <option value="translated" selected>Translated or better</option>
                    <option value="retail">Retail only</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="btn-group">
        <button type="submit" class="btn btn-primary">Save Settings</button>
        <button type="button" class="btn btn-ghost" onclick="loadSettings()">Reset</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    let languages = {{ languages | tojson }};

    function renderLanguageTags() {
        const container = document.getElementById('language-tags');
        container.innerHTML = '';

        languages.forEach(lang => {
            const tag = document.createElement('span');
            tag.className = 'tag tag-gold';
            tag.innerHTML = `
                <span>${lang.toUpperCase()}</span>
                <span class="tag-remove" onclick="event.stopPropagation(); removeLanguage('${lang}')">&#10005;</span>
            `;
            container.appendChild(tag);
        });

        document.getElementById('languages-hidden').value = JSON.stringify(languages);
    }

    document.getElementById('language-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const input = e.target;
            const lang = input.value.trim().toLowerCase();

            if (lang && !languages.includes(lang)) {
                languages.push(lang);
                renderLanguageTags();
                input.value = '';
            }
        }
    });

    function removeLanguage(lang) {
        languages = languages.filter(l => l !== lang);
        renderLanguageTags();
    }

    async function loadSettings() {
        try {
            const response = await fetch('/api/settings');
            const data = await response.json();
            const settings = data.subtitle_settings;

            languages = settings.languages || ['vi'];
            renderLanguageTags();

            document.getElementById('auto_download_on_add').checked = settings.auto_download_on_add;
            document.getElementById('auto_download_on_play').checked = settings.auto_download_on_play;
            document.getElementById('skip_if_has_subtitle').checked = settings.skip_if_has_subtitle;
            document.getElementById('replace_existing').checked = settings.replace_existing;
            document.getElementById('skip_forced_subtitles').checked = settings.skip_forced_subtitles;
            document.getElementById('skip_if_embedded').checked = settings.skip_if_embedded;
            document.getElementById('min_quality_threshold').value = settings.min_quality_threshold;
            document.getElementById('auto_sync_timing').checked = settings.auto_sync_timing ?? true;
            document.getElementById('auto_sync_after_download').checked = settings.auto_sync_after_download ?? true;
            document.getElementById('translation_enabled').checked = (settings.translation_enabled || settings.auto_translate_if_no_vi) ?? false;
            document.getElementById('translation_requires_approval').checked = settings.translation_requires_approval ?? true;
        } catch (error) {
            showAlert('Error loading settings: ' + error.message, 'error');
        }
    }

    document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const settings = {
            languages: languages,
            language_priority: languages,
            auto_download_on_add: formData.get('auto_download_on_add') === 'on',
            auto_download_on_play: formData.get('auto_download_on_play') === 'on',
            skip_if_has_subtitle: formData.get('skip_if_has_subtitle') === 'on',
            replace_existing: formData.get('replace_existing') === 'on',
            skip_forced_subtitles: formData.get('skip_forced_subtitles') === 'on',
            skip_if_embedded: formData.get('skip_if_embedded') === 'on',
            min_quality_threshold: formData.get('min_quality_threshold'),
            auto_sync_timing: formData.get('auto_sync_timing') === 'on',
            auto_sync_after_download: formData.get('auto_sync_after_download') === 'on',
            translation_enabled: formData.get('translation_enabled') === 'on',
            auto_translate_if_no_vi: formData.get('translation_enabled') === 'on',
            translation_requires_approval: formData.get('translation_requires_approval') === 'on',
        };

        try {
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            });

            if (response.ok) {
                showAlert('Settings saved successfully!', 'success');
            } else {
                showAlert('Failed to save settings', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    });

    loadSettings();
</script>
{% endblock %}
